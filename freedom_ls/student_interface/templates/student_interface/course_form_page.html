{% extends "student_interface/_course_base.html" %}

{% load content_tags %}

{% partialdef form-input-multiple-choice %}
    {% for option in question.options.all %}
        <div class="flex items-center">
            <input type="radio"
                   id="q{{ child.id }}_opt{{ option.id }}"
                   name="question_{{ child.id }}"
                   value="{{ option.id }}"
                   class="mr-2"
                   {% if question.required %}required {% endif %}
                   {% if existing_answers|length > 0 %} {% with answer=existing_answers|get_item:child.id %} {% if answer and option in answer.selected_options.all %}checked{% endif %}
                   {% endwith %}
                   {% endif %} />
            <label for="q{{ question.id }}_opt{{ option.id }}" class="cursor-pointer">
                {{ option.text }}
            </label>
        </div>
    {% endfor %}
{% endpartialdef %}

{% partialdef form-input-checkboxes %}
    {% for option in question.options.all %}
        <div class="flex items-center">
            <input type="checkbox"
                   id="q{{ question.id }}_opt{{ option.id }}"
                   name="question_{{ question.id }}"
                   value="{{ option.id }}"
                   class="mr-2"
                   {% if existing_answers|length > 0 %} {% with answer=existing_answers|get_item:question.id %} {% if answer and option in answer.selected_options.all %}checked{% endif %}
                   {% endwith %}
                   {% endif %} />
            <label for="q{{ question.id }}_opt{{ option.id }}" class="cursor-pointer">
                {{ option.text }}
            </label>
        </div>
    {% endfor %}
{% endpartialdef %}

{% partialdef form-input-short-text %}
    <input type="text"
           name="question_{{ question.id }}"
           class="w-full"
           {% if question.required %}required{% endif %}
           {% if existing_answers|length > 0 %} {% with answer=existing_answers|get_item:child.id %} {% if answer %}value="{{ answer.text_answer }}"{% endif %}
           {% endwith %}
           {% endif %} />
{% endpartialdef %}

{% partialdef form-input-long-text %}
    <div class="ml-4">
        <textarea name="question_{{question.id}}"
                  rows="5"
                  class="w-full"
                  {% if question.required %}required{% endif %}>{% if existing_answers|length > 0 %}{% with answer=existing_answers|get_item:question.id %}{% if answer %}{{ answer.text_answer }}{% endif %}{% endwith %}{% endif %}</textarea>
    </div>
{% endpartialdef %}

{% partialdef form-question %}
    <div class="surface">
        <div class="mb-3 flex flex-row gap-2">
            <span class="font-semibold text-gray-900"
                  data-testid="question-number-{{ question.question_number }}">{{ question.question_number }}.</span>
            <span class="text-gray-900">{{ question.rendered_question }}</span>
            {% if question.required %}
                <span class="text-red-600 ml-1"
                      data-testid="required-indicator-{{ question.question_number }}">*</span>
            {% endif %}
        </div>

        <div class="space-y-2 ml-4">

            {% if question.type == "multiple_choice" %}
                {% partial form-input-multiple-choice %}
            {% elif question.type == "checkboxes" %}
                {% partial form-input-checkboxes %}
            {% elif question.type == "short_text" %}
                {% partial form-input-short-text %}
            {% elif question.type == "long_text" %}
                {% partial form-input-long-text %}
            {% else %}
                <div class="p-3 bg-red-100 border border-red-400 text-red-700 rounded">
                    ERROR! UNHANDLED FORM TYPE {{ question.type }}
                </div>
            {% endif %}
        </div>
    </div>
{% endpartialdef %}

{% partialdef form-content %}
    <c-markdown-container class="surface max-w-none">
        {{ child.rendered_content }}
    </c-markdown-container>
{% endpartialdef form-content %}

{% block content %}

    <div class="mb-8">
        <h1 class="mb-2">
            {{ form.title }}
        </h1>
        {% if form.subtitle %}
            <p class="text-gray-600">
                {{ form.subtitle }}
            </p>
        {% endif %}

    </div>

    <!-- Page Progress Indicator -->
    {% if total_pages > 1 %}
        {% partialdef page_progress_indicator inline %}
            <div class="surface space-y-3">
                <div class="text-sm font-medium text-gray-700">
                    <p>
                        Page {{ current_page_num }} of {{ total_pages }}:
                        {{ form_page.title }}
                    </p>
                    {% if form_page.subtitle %}
                        <p class="text-gray-500">
                            {{ form_page.subtitle }}
                        </p>
                    {% endif %}
                </div>

                <!-- Page Navigation -->
                <div class="flex gap-2 flex-wrap">
                    {% for page in page_links %}
                        <c-form-page-link number="{{ page.number }}" is_current="{{ page.is_current }}" is_accessible="{{ page.is_accessible }}" url="{{ page.url }}" title="{{ page.title }}" />
                    {% endfor %}
                </div>
            </div>

        {% endpartialdef %}

    {% endif %}

    {% partialdef form_and_navigation inline %}

        <form method="post">

            {% csrf_token %}

            <!-- Form content -->
            <div class="my-8 space-y-8">
                {% for child in form_page.children %}
                    {% if child.content_type == 'FORM_QUESTION' %}
                        {% with question=child %}
                            {% partial form-question %}
                        {% endwith %}
                    {% elif child.content_type == 'FORM_CONTENT' %}
                        {% partial form-content %}
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Navigation -->

            <div class="flex justify-between items-center pt-6 border-t border-gray-300">
                <div>
                    {% if previous_page_url %}

                        <c-button href="{{ previous_page_url }}" variant="secondary">
                            Back
                        </c-button>
                    {% else %}
                        <div class="w-20">
                        </div>
                    {% endif %}
                </div>
                <div>

                    {% if has_next_page %}

                        <c-button type="submit">
                            Next
                        </c-button>
                    {% else %}
                        {# Last page - show Submit button #}
                        <c-button type="submit">
                            Finish
                        </c-button>
                    {% endif %}
                </div>
            </div>

        </form>
    {% endpartialdef %}

{% endblock content %}
