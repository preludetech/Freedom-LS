# Plan: Deadlines Feature Flag (Deactivation)

Based on: `1. spec.md`

## Overview

Gate all deadline-related behaviour in the student interface behind the existing `DEADLINES_ACTIVE` config setting (`freedom_ls/student_management/config.py`). When `False`, skip deadline DB queries, badges, and locking. Two code changes + a rename + tests.

---

## Task 1: Rename `is_item_locked` to `is_item_locked_by_deadline`

**Files to edit:**
- `freedom_ls/student_management/deadline_utils.py` — rename function definition (line ~366)
- `freedom_ls/student_management/tests/test_deadline_utils.py` — update all references
- `freedom_ls/student_interface/views.py` — update import and call site (lines 29, 147)
- `freedom_ls/student_interface/tests/test_deadline_integration.py` — if it references the old name

**What to do:**
1. Rename `is_item_locked` to `is_item_locked_by_deadline` in `deadline_utils.py`
2. Update all imports and call sites across the codebase
3. Run all tests to confirm nothing breaks

**TDD approach:** Existing tests should still pass after the rename. No new tests needed for a rename.

**Skills/tools:** Use `testing` skill conventions. Run `uv run pytest` to verify.

**After this task:**
1. Use `request-code-review` skill to review changes
2. Run `uv run pytest` to confirm all tests pass
3. Use `commit` skill to commit

---

## Task 2: Gate `get_course_deadlines()` call in `get_course_index()` with `DEADLINES_ACTIVE`

**File to edit:** `freedom_ls/student_interface/utils.py`

**Current code (lines 141-144):**
```python
student = get_student(user)
deadlines_map: dict[...] = {}
if student:
    deadlines_map = get_course_deadlines(student, course)
```

**Desired code:**
```python
from freedom_ls.student_management.config import config

student = get_student(user)
deadlines_map: dict[...] = {}
if student and config.DEADLINES_ACTIVE:
    deadlines_map = get_course_deadlines(student, course)
```

**TDD approach:**
1. Write tests in `freedom_ls/student_interface/tests/test_deadline_integration.py`:
   - `test_get_course_index_skips_deadlines_when_inactive` — mock `config.DEADLINES_ACTIVE` to `False`, set up a deadline, call `get_course_index()`, assert `deadlines` list is empty and item is not BLOCKED
   - `test_get_course_index_includes_deadlines_when_active` — mock `config.DEADLINES_ACTIVE` to `True` (or don't mock — it defaults to `True`), verify existing behaviour still works (this may already be covered by existing tests, check first)
2. Implement the guard
3. Run tests, refactor

**Mocking pattern:** Use `unittest.mock.patch.object(config, '_defaults', {'DEADLINES_ACTIVE': False})` or `@pytest.fixture` with `monkeypatch` to set `config.DEADLINES_ACTIVE`. Since the config checks `django.settings` first, use `@override_settings(DEADLINES_ACTIVE=False)` or mock the config object directly. The spec says: use mocks, do NOT edit the default value.

**Skills/tools:** Use `testing` skill for TDD workflow.

**After this task:**
1. Use `request-code-review` skill to review changes
2. Run `uv run pytest` to confirm all tests pass
3. Use `commit` skill to commit

---

## Task 3: Gate `is_item_locked_by_deadline()` call in `view_course_item()` with `DEADLINES_ACTIVE`

**File to edit:** `freedom_ls/student_interface/views.py`

**Current code (lines 144-148):**
```python
student = get_student(request.user)
if student and not isinstance(current_item, CoursePart):
    is_completed = _is_content_item_completed(current_item, request.user)
    if is_item_locked_by_deadline(student, course, current_item, is_completed=is_completed):
        return redirect("student_interface:course_home", course_slug=course_slug)
```

**Desired code:**
```python
from freedom_ls.student_management.config import config

# ... inside view_course_item:
if config.DEADLINES_ACTIVE:
    student = get_student(request.user)
    if student and not isinstance(current_item, CoursePart):
        is_completed = _is_content_item_completed(current_item, request.user)
        if is_item_locked_by_deadline(student, course, current_item, is_completed=is_completed):
            return redirect("student_interface:course_home", course_slug=course_slug)
```

**TDD approach:**
1. Write tests in `freedom_ls/student_interface/tests/test_deadline_integration.py`:
   - `test_view_course_item_skips_lock_check_when_deadlines_inactive` — set `DEADLINES_ACTIVE=False`, create an expired hard deadline, access the item via the view, assert it returns 200 (not a redirect)
   - `test_view_course_item_still_locks_when_deadlines_active` — already covered by existing `test_view_course_item_redirects_if_locked`, but verify
2. Implement the guard
3. Run tests, refactor

**Skills/tools:** Use `testing` skill for TDD workflow.

**After this task:**
1. Use `request-code-review` skill to review changes
2. Run `uv run pytest` to confirm all tests pass
3. Use `commit` skill to commit

---

## After Task 3: Cumulative review

Since this is the 3rd task:
1. Use `request-code-review` skill to review ALL changes made so far
2. Run `uv run pytest` in a subagent to confirm all tests pass
3. Use `commit` skill if needed

---

## Task 4: Final verification and frontend QA

1. Run the full test suite: `uv run pytest`
2. Verify all success criteria from the spec:
   - When `DEADLINES_ACTIVE=False`: no deadline queries, no badges, no locking
   - When `DEADLINES_ACTIVE=True`: behaviour unchanged
   - Admin/educator interfaces unaffected
   - All existing deadline tests pass
   - New tests verify both states

**After this task:**
1. Use `request-code-review` skill to review ALL changes for the entire plan
2. Run all tests in a subagent and confirm they pass
3. Use `commit` skill if needed
4. Execute the frontend QA plan in `3. frontend_qa.md` using `spec_driven_dev:do_qa` skill
