# Deadline Functionality Specification

## Overview

Educators need to manage deadlines for cohorts and individual students. Deadlines can apply to an entire course or to specific content items (topics, forms, course parts). Deadlines are either **hard** (block access after expiry) or **soft** (informational only).

---

## 1. Data Models

All deadline models live in the `student_management` app, co-located with the registration models they reference.

### 1.1 CohortDeadline

Represents a deadline applied to all students in a cohort for a specific course registration.

| Field | Type | Notes |
|---|---|---|
| `cohort_course_registration` | FK → CohortCourseRegistration | CASCADE on delete |
| `content_type` | FK → ContentType | Nullable. Part of generic FK to content item |
| `object_id` | UUIDField | Nullable. Part of generic FK to content item |
| `content_item` | GenericForeignKey | Nullable. If null, deadline applies to the course as a whole. If set, points to a Topic, Form, or CoursePart. A CoursePart deadline effectively applies to the last item in that part. |
| `deadline` | DateTimeField | The deadline datetime |
| `is_hard_deadline` | BooleanField | Default: True. Hard deadlines block access; soft deadlines are informational |

**Why this matters:** Cohort-level deadlines are the primary way educators schedule work. One deadline record covers all students in the cohort, reducing admin overhead.

**Constraints:**
- Unique on `(cohort_course_registration, content_type, object_id)` — one deadline per content item per cohort registration. For course-level deadlines (where content_type and object_id are both null), enforce uniqueness at application level since unique constraints don't work with nulls.
- Must inherit from SiteAwareModel (UUID PK, site FK)

### 1.2 StudentDeadline

Represents a deadline for a student who is registered for a course **individually** (i.e. via a StudentCourseRegistration, not through a cohort).

| Field | Type | Notes |
|---|---|---|
| `student_course_registration` | FK → StudentCourseRegistration | CASCADE on delete |
| `content_type` | FK → ContentType | Nullable. Part of generic FK to content item |
| `object_id` | UUIDField | Nullable. Part of generic FK to content item |
| `content_item` | GenericForeignKey | Nullable. If null, deadline applies to the course as a whole |
| `deadline` | DateTimeField | The deadline datetime |
| `is_hard_deadline` | BooleanField | Default: True |

**Why this matters:** Some students are registered for courses individually, outside of any cohort. They still need deadlines.

**Constraints:**
- Unique on `(student_course_registration, content_type, object_id)` — one deadline per content item per student registration. Same null-handling caveat as CohortDeadline.
- Must inherit from SiteAwareModel

### 1.3 StudentCohortDeadlineOverride

Represents an override deadline for a specific student within a cohort. The student is registered for the course **through the cohort** (via CohortCourseRegistration), not individually. This allows educators to give a specific student a different deadline than the rest of their cohort.

| Field | Type | Notes |
|---|---|---|
| `cohort_course_registration` | FK → CohortCourseRegistration | CASCADE on delete |
| `student` | FK → Student | CASCADE on delete. The student within the cohort who gets the override |
| `content_type` | FK → ContentType | Nullable. Part of generic FK to content item |
| `object_id` | UUIDField | Nullable. Part of generic FK to content item |
| `content_item` | GenericForeignKey | Nullable. If null, override applies to the course as a whole |
| `deadline` | DateTimeField | The override deadline datetime |
| `is_hard_deadline` | BooleanField | Default: True |

**Why this matters:** Within a cohort, individual students may need accommodations — extensions, adjusted schedules, or different deadline types (hard vs soft). This model allows per-student overrides without requiring a separate StudentCourseRegistration.

**Constraints:**
- Unique on `(cohort_course_registration, student, content_type, object_id)` — one override per student per content item per cohort registration. Same null-handling caveat as CohortDeadline.
- The student must be a member of the cohort referenced by the cohort_course_registration (enforce at application level)
- Must inherit from SiteAwareModel
---

## 2. Deadline Resolution Logic

When determining the effective deadline for a student on a given content item, apply these rules in order:

### 2.1 Filter: Active Registrations Only

Deadlines from **inactive** course registrations (where `is_active=False`) are completely ignored. They have no effect and are not displayed.

### 2.2 Priority: Most Specific Beats General on a Cohort level

1. **StudentCohortDeadlineOverride** — if the student is in a cohort and has a per-student override, use it.
2. **CohortDeadline** — fall back to the cohort-level deadline.

**StudentDeadline** does not interfere with cohort deadlines. It is a separate thing. 


### 2.3 Multiple Competing Deadlines

If a student has multiple competing deadlines for the same item (e.g. from two different cohort registrations), 
- Show the student both deadlines
- Use the most permissive deadline for access control

#### Scenario 1. Multiple cohorts with overrides

For example if a student is in 2 cohorts both registered for the same course:
- Cohort 1: sets a cohort level deadline for an item (D1)
- Cohort 2: sets a cohort level deadline (D2) for the same item, and - StudentCohortDeadlineOverride for that same item (D3)

Show the student D1 and D3 on the table of contents

#### Scenario 2: Cohort registration and student registration 

If a student is in a cohort registered for a course, and is directly registered for the course as well:
- Cohort has cohort level deadline D1
- StudentDeadline specifies D2 

The student should see D1 and D2 because the individual registrations do not interfere with each other.

### 2.4 Item-Level vs Course-Level Deadlines

Within a single registration, a student may have both a course-level deadline and an item-level deadline. These interact as follows:
- If an **item-level deadline** exists for a specific content item, it takes precedence over the course-level deadline for that item.
- If no item-level deadline exists, the **course-level deadline** applies.

**Resolution order:** First resolve item-level vs course-level within each registration (this section). Then, if multiple registrations produce competing effective deadlines for the same item, apply the multiple-deadline rules from Section 2.3 (show all, use most permissive for access control).

**Why this matters:** Clear precedence rules prevent confusion and ensure students always know what deadline applies. The "most permissive" rule ensures students aren't unfairly penalised by administrative overlaps.

---

## 3. Access Control (Hard Deadlines)

Hard deadlines restrict access to content after they expire.

### 3.1 Item-Level Hard Deadline (Expired)

- If the student has **not completed** the item, it is **locked** — inaccessible from the table of contents.
- If the student has **already completed** the item, it remains **viewable**.

### 3.2 CoursePart-Level Hard Deadline (Expired)

- A CoursePart deadline effectively applies to the **last item** in the part.
- Completion is determined by whether the last item in the CoursePart is complete.
- The deadline is displayed on the CoursePart row in the table of contents, not on individual items within it.

### 3.3 Course-Level Hard Deadline (Expired)

- All **incomplete** items in the course are **locked**.
- All **completed** items remain **viewable**.

### 3.4 Soft Deadlines

Soft deadlines have **no access control effect**. They are purely informational — displayed in the UI but do not restrict access regardless of whether they have passed.

**Why this matters:** Hard deadlines enforce progression expectations while still allowing students to review their completed work. Soft deadlines give educators a way to communicate expectations without punitive lockouts.

---

## 4. Display to Learners

### 4.1 Table of Contents

Deadlines are displayed on the table of contents alongside each content item:

- **Hard deadlines:** displayed in **red**
- **Soft deadlines:** displayed in **orange**
- **Expired hard deadlines** (item not completed): item is visually locked/greyed out and not clickable
- **Expired hard deadlines** (item completed): item remains accessible, deadline display can be muted

### 4.2 Multiple Deadlines

If a student has multiple deadlines for the same item (from duplicate registrations), both are displayed. The one governing access control (the most permissive) should be visually distinguished.

**Why this matters:** Colour-coded deadlines give students an at-a-glance understanding of urgency. Locked items provide clear feedback that the window has closed.

---

## 5. Admin Panel

### 5.1 CohortDeadline Admin

- Editable through Django admin using Unfold and SiteAwareModelAdmin
- Should be available as an inline on the CohortCourseRegistration admin (if one exists) and as a standalone model admin
- List display: cohort name, course name, content item (or "Whole course"), deadline, is_hard_deadline
- Filters: cohort, course, is_hard_deadline
- Search: cohort name, course title

### 5.2 StudentDeadline Admin

- Editable through Django admin using Unfold and SiteAwareModelAdmin
- Should be available as an inline on the StudentCourseRegistration admin (if one exists) and as a standalone model admin
- List display: student name, course name, content item (or "Whole course"), deadline, is_hard_deadline
- Filters: course, is_hard_deadline
- Search: student name, course title

### 5.3 StudentCohortDeadlineOverride Admin

- Editable through Django admin using Unfold and SiteAwareModelAdmin
- Should be available as an inline on the CohortCourseRegistration admin alongside CohortDeadline inlines
- List display: student name, cohort name, course name, content item (or "Whole course"), deadline, is_hard_deadline
- Filters: cohort, course, is_hard_deadline
- Search: student name, cohort name, course title

**Why this matters:** Admin access lets educators manage deadlines without requiring a dedicated UI, which can be built later. Inline display keeps related data together.

---

## 6. Success Criteria

### Models
- [ ] CohortDeadline model exists with all specified fields, inherits SiteAwareModel
- [ ] StudentDeadline model exists with all specified fields, inherits SiteAwareModel
- [ ] StudentCohortDeadlineOverride model exists with all specified fields, inherits SiteAwareModel
- [ ] Migrations run cleanly
- [ ] Uniqueness constraints prevent duplicate deadlines for the same item

### Resolution Logic
- [ ] Only deadlines from active registrations are considered
- [ ] StudentCohortDeadlineOverride overrides CohortDeadline for that specific student
- [ ] StudentDeadline (from individual registration) coexists independently with cohort deadlines — they do not override each other
- [ ] When multiple competing deadlines exist, the latest (most permissive) one governs access
- [ ] Item-level deadlines override course-level deadlines for the specific item
- [ ] A utility function/method exists to resolve the effective deadline for a given student + content item

### Access Control
- [ ] Hard deadline expired + item incomplete = item locked (inaccessible from table of contents)
- [ ] Hard deadline expired + item completed = item remains viewable
- [ ] Course-level hard deadline expired = all incomplete items locked, completed items remain viewable
- [ ] Soft deadlines never restrict access

### Display
- [ ] Hard deadlines shown in red on the table of contents
- [ ] Soft deadlines shown in orange on the table of contents
- [ ] Locked items are visually distinct and not clickable
- [ ] Multiple deadlines (from duplicate registrations) are both visible

### Admin
- [ ] CohortDeadline is manageable via Django admin
- [ ] StudentDeadline is manageable via Django admin
- [ ] StudentCohortDeadlineOverride is manageable via Django admin
- [ ] All three are available as inlines on their respective registration admins
