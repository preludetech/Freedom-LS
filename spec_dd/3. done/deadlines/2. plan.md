# Deadline Feature — Implementation Plan

This plan implements the deadline functionality described in `1. spec.md`. We follow TDD throughout — each task writes tests first, then implementation.

**Skills to use globally:**
- **testing** / **tdd_implement**: Every task follows TDD — write failing tests, then implement
- **multi-tenant**: All new models inherit `SiteAwareModel`, use `SiteAwareModelAdmin`
- **admin-interface**: Admin classes use Unfold + `SiteAwareModelAdmin` patterns
- **template** / **frontend-styling**: TOC template changes use cotton components + TailwindCSS v4
- **commit**: Commit after each completed task

---

## Phase 1: Data Models

### Task 1.1 — Create CohortDeadline model

**File:** `freedom_ls/student_management/models.py`

Add `CohortDeadline` model inheriting from `SiteAwareModel`:

```python
class CohortDeadline(SiteAwareModel):
    cohort_course_registration = models.ForeignKey(
        CohortCourseRegistration, on_delete=models.CASCADE, related_name="deadlines"
    )
    content_type = models.ForeignKey(
        DjangoContentType, on_delete=models.CASCADE, null=True, blank=True
    )
    object_id = models.UUIDField(null=True, blank=True)
    content_item = GenericForeignKey("content_type", "object_id")
    deadline = models.DateTimeField()
    is_hard_deadline = models.BooleanField(default=True)
```

Follow the `GenericForeignKey` pattern from `freedom_ls/content_engine/models.py:211-230` (`ContentCollectionItem`), using `UUIDField` for `object_id` since all content models use UUID PKs.

**Constraints:**
- `UniqueConstraint` on `(cohort_course_registration, content_type, object_id)` for non-null content items
- Application-level validation for course-level uniqueness (where content_type and object_id are both null) via `clean()` method, since DB unique constraints don't work with NULLs

**Tests:** Model creation, uniqueness constraints, null content_item means "whole course", `__str__` method.

**Run:** `uv run manage.py makemigrations` and `uv run manage.py migrate`

### Task 1.2 — Create StudentDeadline model

**File:** `freedom_ls/student_management/models.py`

Same pattern as CohortDeadline but with FK to `StudentCourseRegistration` instead:

```python
class StudentDeadline(SiteAwareModel):
    student_course_registration = models.ForeignKey(
        StudentCourseRegistration, on_delete=models.CASCADE, related_name="deadlines"
    )
    # ... same content_type/object_id/content_item/deadline/is_hard_deadline fields
```

**Constraints:** Same uniqueness approach as CohortDeadline.

**Tests:** Model creation, uniqueness, null content_item.

**Run:** `uv run manage.py makemigrations` and `uv run manage.py migrate`

### Task 1.3 — Create StudentCohortDeadlineOverride model

**File:** `freedom_ls/student_management/models.py`

```python
class StudentCohortDeadlineOverride(SiteAwareModel):
    cohort_course_registration = models.ForeignKey(
        CohortCourseRegistration, on_delete=models.CASCADE, related_name="deadline_overrides"
    )
    student = models.ForeignKey(
        Student, on_delete=models.CASCADE, related_name="cohort_deadline_overrides"
    )
    # ... same content_type/object_id/content_item/deadline/is_hard_deadline fields
```

**Constraints:**
- `UniqueConstraint` on `(cohort_course_registration, student, content_type, object_id)` for non-null content items
- Application-level `clean()` for null content_item uniqueness and for verifying the student is a member of the cohort (check via `CohortMembership`)

**Tests:** Model creation, uniqueness, student-must-be-in-cohort validation.

**Run:** `uv run manage.py makemigrations` and `uv run manage.py migrate`

---

## Phase 2: Admin Interface

**Skill:** admin-interface

### Task 2.1 — CohortDeadline admin

**File:** `freedom_ls/student_management/admin.py`

- Register standalone `CohortDeadlineAdmin(SiteAwareModelAdmin)` with:
  - `list_display`: cohort name, course name, content item (or "Whole course"), deadline, is_hard_deadline
  - `list_filter`: `cohort_course_registration__cohort`, `cohort_course_registration__collection`, `is_hard_deadline`
  - `search_fields`: `cohort_course_registration__cohort__name`, `cohort_course_registration__collection__title`
- Create `CohortDeadlineInline(TabularInline)` — add it to `CohortCourseRegistrationAdmin.inlines` (currently at line 129)

**Pattern:** Follow existing `StudentCourseRegistrationInline` (line 26) and `CohortCourseRegistrationAdmin` (line 129) patterns.

### Task 2.2 — StudentDeadline admin

**File:** `freedom_ls/student_management/admin.py`

- Register standalone `StudentDeadlineAdmin(SiteAwareModelAdmin)`
- Create `StudentDeadlineInline(TabularInline)` — add to `StudentCourseRegistrationAdmin.inlines`

### Task 2.3 — StudentCohortDeadlineOverride admin

**File:** `freedom_ls/student_management/admin.py`

- Register standalone `StudentCohortDeadlineOverrideAdmin(SiteAwareModelAdmin)`
- Create `StudentCohortDeadlineOverrideInline(TabularInline)` — add to `CohortCourseRegistrationAdmin.inlines` alongside the CohortDeadlineInline from Task 2.1

---

## Phase 3: Deadline Resolution Logic

### Task 3.1 — Create deadline resolution utility

**File:** `freedom_ls/student_management/deadline_utils.py` (new file)

Create a function to resolve the effective deadlines for a student on a specific content item:

```python
def get_effective_deadlines(student: Student, course: Course, content_item=None) -> list[EffectiveDeadline]:
    """
    Resolve all effective deadlines for a student on a content item (or the course as a whole).

    Returns a list of EffectiveDeadline namedtuples/dataclasses, one per registration that
    produces a deadline. Each contains: deadline (datetime), is_hard_deadline (bool),
    source (str description).

    Resolution per registration:
    1. If student is in a cohort registered for this course:
       a. Check StudentCohortDeadlineOverride for this student + item — if found, use it
       b. Else fall back to CohortDeadline for this item
       c. If no item-level deadline, fall back to course-level deadline from same registration
    2. If student has a StudentCourseRegistration:
       a. Check StudentDeadline for this item
       b. If no item-level deadline, fall back to course-level StudentDeadline
    3. Only include deadlines from active registrations (is_active=True)
    4. Return all resolved deadlines (one per registration that has one)
    """
```

Also create a convenience function for access control:

```python
def is_item_locked(student: Student, course: Course, content_item, is_completed: bool) -> bool:
    """
    Determine if a content item should be locked due to an expired hard deadline.

    - If the item is completed, it's never locked
    - Get all effective deadlines for this item
    - If any hard deadline has expired and item is not completed, check if the
      most permissive (latest) hard deadline has also expired
    - Soft deadlines never lock
    """
```

For CoursePart deadlines: resolve them by checking the last item in the part (per spec 3.2).

**Tests:** This is the most complex task. Test scenarios from spec section 2:
- Single cohort deadline resolves correctly
- Override beats cohort deadline for that student
- Student with two cohort registrations sees both deadlines
- Student with cohort + individual registration sees both
- Item-level deadline beats course-level within same registration
- Inactive registrations are ignored
- Most permissive deadline governs access

### Task 3.2 — Create bulk deadline resolution for TOC

**File:** `freedom_ls/student_management/deadline_utils.py`

```python
def get_course_deadlines(student: Student, course: Course) -> dict:
    """
    Get all deadlines for all items in a course, optimised for the TOC view.

    Returns a dict keyed by (content_type_id, object_id) tuples, where each
    value is a list of EffectiveDeadline objects. A key of (None, None)
    represents the course-level deadline.

    Uses select_related/prefetch_related to minimise queries.
    """
```

This function pre-fetches all deadlines for the course in bulk (rather than per-item) so the TOC doesn't produce N+1 queries.

**Tests:** Verify bulk resolution matches per-item resolution for various scenarios.

---

## Phase 4: Student Interface — TOC Display

### Task 4.1 — Integrate deadlines into `get_course_index`

**File:** `freedom_ls/student_interface/utils.py`

Modify `get_course_index()` (line 117) and `create_child_dict_with_flattened_index()` (line 138) to:

1. Look up the `Student` for the current user
2. Call `get_course_deadlines(student, course)` from `deadline_utils.py`
3. Attach deadline info to each `child_dict`:
   ```python
   child_dict["deadlines"] = [...]  # list of {datetime, is_hard, is_expired, source}
   ```
4. For CoursePart items, attach the CoursePart-level deadline to the part dict (not individual children)

**Tests:** Test that `get_course_index` includes deadline data in child dicts.

### Task 4.2 — Update TOC template for deadline display

**Files:**
- `freedom_ls/student_interface/templates/student_interface/partials/course_minimal_toc.html`

**Skills:** template, frontend-styling, brand-guidelines

Add deadline display to each TOC row. After the title and before the status icon, show deadline badges:

- Hard deadlines: red text (`text-danger`)
- Soft deadlines: orange text (`text-warning`)
- Format: date only, or relative time if close
- If multiple deadlines, show all
- For the most permissive deadline (governing access), visually distinguish it (e.g. bold or with an icon)

Update the `{% partialdef status-icon %}` to handle a new `LOCKED_DEADLINE` status (or reuse the existing `BLOCKED` status with deadline-specific styling).

### Task 4.3 — Implement access control (hard deadline locking)

**File:** `freedom_ls/student_interface/utils.py`

Modify `get_content_status()` (line 22) or the TOC-building logic to:

1. After determining the normal status, check if the item is locked by a hard deadline
2. If the item is not completed AND the most permissive hard deadline has expired → set status to `BLOCKED` and set `url` to `None`
3. If the item IS completed, leave it accessible regardless of deadline
4. Soft deadlines never change the status

Also add access control in `view_course_item()` (`views.py:136`) — if a student navigates directly to a locked item's URL, redirect them back to the course TOC (or show a message).

**Tests:**
- Item with expired hard deadline + incomplete → BLOCKED
- Item with expired hard deadline + completed → still accessible
- Course-level hard deadline locks all incomplete items
- Soft deadline → no locking
- Direct URL access to locked item → redirect

---

## Phase 5: Final QA

### Task 5.1 — Manual frontend QA

Follow the QA checklist in `3. frontend_qa.md` to verify all deadline functionality works correctly in the browser.

**Skill:** use-playwright
