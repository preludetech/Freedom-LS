# Plan: Educator Interface — Cohort Course Progress Panel

## Overview

Add a new "Course Progress" panel to `CohortInstanceView` that displays a grid of student progress across course items, with pagination, deadlines, and HTMX-powered course selection.

## Skills & MCPs to use

- **testing** skill: For all TDD work (every task writes tests first)
- **tdd_implement** skill: For the Red-Green-Refactor cycle
- **template** skill: When creating/editing Django templates and cotton components
- **frontend-styling** skill: For TailwindCSS styling of the grid, cells, deadline indicators
- **brand-guidelines** skill: For colour choices, visual styling decisions
- **multi-tenant** skill: When creating/modifying models (the `progress_percentage` field on `CourseProgress`)
- **commit** skill: After each task is reviewed and tests pass
- **spec_driven_dev:do_qa** skill: For the final frontend QA step using `3. frontend_qa.md`
- **Playwright MCP**: For interactive browser testing during QA

---

## Task 1: Add `progress_percentage` field to `CourseProgress`

**Goal:** Add a denormalized `progress_percentage` integer field to `CourseProgress` so sorting/pagination can happen in SQL.

**Files to edit:**
- `freedom_ls/student_progress/models.py` — Add field to `CourseProgress` (line ~436)
- New migration file (via `makemigrations`)

**Details:**
- Add `progress_percentage = models.IntegerField(default=0)` to `CourseProgress`
- Run `uv run manage.py makemigrations` and `uv run manage.py migrate`

**TDD tests** (in new file `freedom_ls/student_progress/tests/test_course_progress.py`):
- Test that `CourseProgress` can be created with default `progress_percentage=0`
- Test that `progress_percentage` field exists and defaults to 0

**Skills:** testing, tdd_implement, multi-tenant

---

## Task 2: Auto-update `progress_percentage` when items are completed

**Goal:** When a `TopicProgress` or `FormProgress` is marked complete, recalculate and save `progress_percentage` on the corresponding `CourseProgress` record(s).

**Files to edit:**
- `freedom_ls/student_progress/models.py` — Add a function that updates `CourseProgress.progress_percentage`. Call it from appropriate places.

**Details:**

The update function should:
1. Accept a user and a content item (topic or form)
2. Find which courses contain this item by querying `ContentCollectionItem` where `child_type` + `child_id` match the item. Items may be direct children of a Course, or children of a CoursePart that is itself a child of a Course — trace through both levels.
3. For each affected course, find/create the `CourseProgress` record for the user
4. Use `calculate_course_progress_percentage()` from `freedom_ls/student_management/utils.py` to compute the new value (pass it the course plus sets of completed topic/form IDs for that user)
5. Save the updated `progress_percentage`

**Where to call it:**
- `TopicProgress`: When `complete_time` is set. The spec notes that both `TopicProgress` and `FormProgress` inherit from `CourseItemProgress` — aim for DRY code. Consider adding a method/hook on `CourseItemProgress` or a standalone utility that both models call.
- `FormProgress.complete()` method (line ~70 approx in models.py) — after marking `completed_time`, trigger the update.

**Important:** The completion field names differ: `TopicProgress.complete_time` vs `FormProgress.completed_time`. The DRY approach should handle this.

**TDD tests** (in `freedom_ls/student_progress/tests/test_course_progress.py`):
- Test: completing a topic updates `progress_percentage` on the related `CourseProgress`
- Test: completing a form updates `progress_percentage`
- Test: completing an item inside a CoursePart traces up to the parent Course and updates correctly
- Test: completing an item that appears in multiple courses updates all relevant `CourseProgress` records
- Test: `progress_percentage` is 0 when no items are complete, 100 when all are complete
- Test: partial completion gives correct percentage (e.g. 2 of 4 items = 50%)

**Skills:** testing, tdd_implement

---

## Task 3: Build the `CohortCourseProgressPanel` class (no template yet)

**Goal:** Create a new `Panel` subclass that handles course selection, pagination state, and data fetching for the progress grid.

**Files to edit:**
- `freedom_ls/educator_interface/views.py` — Add `CohortCourseProgressPanel` class and register it in `CohortInstanceView.panels`

**Details:**

The panel's `get_content()` method should:

1. **Course selection:**
   - Query `CohortCourseRegistration` for the cohort, ordering active first, then by title
   - Determine selected registration from `request.GET.get("registration")` or default to first active (or first inactive if none active)
   - If no registrations exist, return empty state HTML

2. **Column pagination (course items):**
   - Use `Course.children_flat()` to get all items, filter out `CoursePart` instances to get only Topics and Forms
   - Build a mapping of CoursePart → child items for grouped headers
   - Page size: 15 items. Get `col_page` from `request.GET` (default 1)
   - Slice the items list for the current column page
   - Use `django.core.paginator.Paginator` for column pagination

3. **Student pagination (rows):**
   - Query `CohortMembership` for the cohort, `select_related("student__user")`
   - LEFT JOIN to `CourseProgress` (for the selected course) via annotation/subquery to get `progress_percentage`
   - Students without `CourseProgress` treated as 0% — use `Coalesce` with default 0
   - Order by `progress_percentage` ASC (NULLs/0 first)
   - Paginate with `Paginator`, page from `request.GET.get("page")`, page size ~20

4. **Cell data fetching (Phase 2):**
   - Get visible student user IDs and visible item IDs from the paginated results
   - Fetch `TopicProgress` for visible students × visible topics
   - Fetch `FormProgress` for visible students × visible forms (need latest completed attempt + attempt count per user/form for quizzes)
   - Fetch `CohortDeadline` for the registration, filtered to visible items (use `content_type` + `object_id` Q filters for Topic and Form ContentTypes) + course-level deadlines (null content_type/object_id)
   - Fetch `StudentCohortDeadlineOverride` for visible students × visible items + course-level overrides

5. **Build context dict** with all data needed for template rendering

**Register the panel** in `CohortInstanceView.panels` (line ~414):
```python
class CohortInstanceView(InstanceView):
    panels = {
        "details": CohortDetailsPanel,
        "courses": CourseRegistrationsPanel,
        "students": CohortStudentsPanel,
        "course_progress": CohortCourseProgressPanel,  # NEW
    }
```

**TDD tests** (in new file `freedom_ls/educator_interface/tests/test_cohort_course_progress_panel.py`):
- Test: panel renders for a cohort with no course registrations (empty state)
- Test: panel renders with course registrations, defaults to first active
- Test: selecting a specific registration via GET param works
- Test: inactive registrations are included in the dropdown data
- Test: students are sorted by progress ascending
- Test: students with no CourseProgress appear first (0%)
- Test: column pagination slices items correctly
- Test: cell data is fetched only for visible window (visible students × visible items)
- Test: HTMX request returns just the panel content (not wrapped in panel_container)

**Skills:** testing, tdd_implement

---

## Task 4: Create the progress grid template

**Goal:** Build the HTML template for the progress grid with frozen headers/columns, course selection dropdown, and pagination controls.

**Files to create/edit:**
- `freedom_ls/educator_interface/templates/educator_interface/partials/course_progress_panel.html` — Main panel template
- Possibly cotton components for reusable grid elements

**Details:**

The template should include:

1. **Course selection dropdown** at the top
   - `<select>` listing all registrations, with "(inactive)" label for inactive ones
   - HTMX: `hx-get` to reload the panel when selection changes, sending `registration=<pk>` as query param
   - `hx-target` should target the panel container
   - Preserve current page/col_page params or reset them on course change

2. **Course-level deadline display** (if any deadline has null content_type/object_id)

3. **Progress grid** using a `<div>` with `overflow-auto` for scrolling:
   - **Frozen first column** (student names): Use `sticky left-0` CSS
   - **Frozen header row(s)**: Use `sticky top-0` CSS
   - **Header Row 1** (if course has CourseParts): Course part names with `colspan` spanning child items
   - **Header Row 2** (or Row 1 if no parts): Item names + cohort deadline info per column
   - **Body rows**: One per student, with name in first cell (linked to student detail page) and progress cells

4. **Cell content** (use template includes or conditionals):
   - Topics: checkmark + datetime if completed, play icon + start datetime if started, dash if not started
   - Quiz forms: percentage + pass/fail + attempt count if completed, play icon if started, dash if not started
   - Non-quiz forms: same as topics (checkmark/play/dash)
   - Deadline overrides: show if student has override differing from cohort default
   - Overdue highlighting: red styling if deadline passed and item not completed (stronger for hard deadlines)

5. **Pagination controls:**
   - Column pagination: Prev/Next buttons, HTMX-powered, send `col_page` param
   - Student pagination: Standard pagination controls, send `page` param
   - Both should preserve the other's current page + the selected registration

**Skills:** template, frontend-styling, brand-guidelines

---

## Task 5: Style the grid and deadline indicators

**Goal:** Apply proper TailwindCSS styling to make the grid usable and visually clear.

**Details:**
- Frozen column/header styling with proper z-index layering
- Colour coding for cell states (completed = green tones, started = amber, not started = neutral)
- Deadline display in headers: distinct styling for hard vs soft deadlines
- Student deadline overrides: visually distinguished from cohort defaults (different colour/icon)
- Overdue cells: red border/background, stronger for hard deadline violations
- Responsive considerations for the scrollable grid
- Empty state styling

**Files to edit:**
- The template(s) from Task 4
- Possibly `npm run tailwind_build` if new utility classes are needed

**Skills:** frontend-styling, brand-guidelines

---

## Task 6: Frontend QA

**Goal:** Execute the frontend QA test plan to verify everything works correctly in a browser.

**File:** `spec_dd/2. in progress/educator-interface-cohort-course-progress/3. frontend_qa.md`

**Skills:** spec_driven_dev:do_qa, Playwright MCP (use-playwright)
