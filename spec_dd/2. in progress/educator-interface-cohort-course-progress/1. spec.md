# Spec: Educator Interface — Cohort Course Progress Panel

## Overview

A new custom panel in the educator interface that displays a detailed progress grid for students in a cohort, showing their completion status across all items in a selected course. This gives educators a bird's-eye view of how each student is progressing, highlights students who need attention, and surfaces deadline information.

## Why this matters

Educators currently see which courses a cohort is registered for, and which students are in a cohort, but they have no consolidated view of how students are progressing through course content. This panel closes that gap — it lets educators:

- Quickly identify students who are falling behind
- See deadline compliance at a glance
- Monitor quiz performance across the cohort
- Track completion of individual course items without navigating to each student separately

## Panel location and integration

The panel plugs into the existing `CohortInstanceView` as a new panel (alongside the existing "details", "courses", and "students" panels). It uses the educator interface's existing panel system by subclassing `Panel`.

The panel is rendered via the standard `__panels/{panel_name}` URL path, making it HTMX-loadable.

## Course selection

- A **dropdown/select** at the top of the panel lists all `CohortCourseRegistration` records for the cohort. Note: the FK to Course on this model is called `collection` (not `course`).
- **Both active and inactive** registrations are shown. Inactive registrations are labelled with "(inactive)" so educators can still review historical data.
- Selecting a course reloads the progress grid via HTMX.
- The first active registration is selected by default. If there are no active registrations, the first inactive one is selected.
- If the cohort has no course registrations, the panel shows an empty state message.

**Why show inactive registrations:** Educators may need to review progress data from previous terms or deactivated courses. Hiding them would lose access to potentially valuable historical information.

## Progress grid layout

### Structure

The grid is a scrollable table with:

- **Frozen first column** (student names) — always visible during horizontal scroll.
- **Frozen header row(s)** — always visible during vertical scroll.
- The rest of the table scrolls freely in both X and Y directions.

### Header rows

**If the course has CourseParts:**

- **Row 1:** Course part names, spanning across their child items (merged cells).
- **Row 2:** Individual course item names (topics and forms).

**If the course has no CourseParts (flat structure):**

- **Row 1:** Individual course item names only.

Column order follows the course's content ordering (the order items appear in the course structure).

### Column pagination

Courses can have many items (e.g. 100+ topics). Displaying all columns at once would make the grid unusable. The grid paginates columns using a **fixed page size** (e.g. 10-15 items per page).

- **Prev/Next controls** allow the educator to navigate through column pages.
- Column pages are sliced from the flat, ordered list of all course items (topics and forms). A course part boundary does not force a page break — items flow continuously across pages.
- The **course part header row** (if present) still spans correctly: if a course part straddles a column page boundary, only the visible portion of the span is shown, with the course part name still displayed.
- Column pagination is independent of row (student) pagination — changing one does not reset the other.

### Student rows

- **One row per student** in the cohort (via `CohortMembership`).
- **Sorted by overall course progress** (ascending — least progress first), so students who need the most attention appear at the top.
- **Paginated vertically** with pagination controls. This ensures the panel remains performant for large cohorts.

**Why sort by progress ascending:** The primary use case is identifying students who need help. Putting the least-progressed students at the top means the educator sees the most actionable information first.

### Performance: Denormalized progress percentage

Sorting and paginating by progress requires an efficient `ORDER BY` in SQL. The existing `calculate_percentage_complete()` method on `CourseProgress` runs one query per course item per student (N*M queries), which is not viable for a cohort-wide view.

**Solution:** Add a `progress_percentage` integer field to `CourseProgress`, updated whenever a topic or form is marked complete.  This enables:

- `ORDER BY progress_percentage` in the database, making pagination + sorting a single indexed query.
- No runtime recalculation — the value is kept in sync at write time.

**Update mechanism:** When a `TopicProgress` or `FormProgress` is marked complete, recalculate and save the `progress_percentage` on the corresponding `CourseProgress` record(s). Use the existing `calculate_course_progress_percentage` utility (from `student_management/utils.py`, which accepts `course`, `completed_topic_ids`, and `completed_form_ids`) to compute the value efficiently.

To find which courses are affected, look up `ContentCollectionItem` records where the completed topic/form is a child (via `child_type` + `child_id`), then trace up to the parent course. Note that items inside a CoursePart need to trace through two levels: item → CoursePart → Course.

Note that both TopicProgress and FormProgress inherit from `CourseItemProgress`. We are likely to add different types of content in future (eg ProjectProgress). Aim for DRY code that won't require rework as new Progress models are implemented. Be aware that the completion field names differ: `TopicProgress.complete_time` vs `FormProgress.completed_time`.

**Why denormalize rather than compute at read time:** The panel needs to paginate (e.g. show students 1-20 of 60 sorted by progress). Computing progress for all 60 students just to sort and then discarding most of them is wasteful. A denormalized field lets the database handle sorting and pagination natively.

### First column

Each row's first cell shows the student's name (first + last), or their email address (if their name is null) linked to their student detail page in the educator interface.

## Cell content by item type

### Topics

| State | Display |
|-------|---------|
| Completed | Check mark icon + completion datetime |
| Started (not complete) | Play icon + start datetime |
| Not started | Empty / dash |

### Forms — Quiz type

| State | Display |
|-------|---------|
| Completed (at least one attempt) | Latest score as percentage + pass/fail indicator (if `quiz_pass_percentage` is configured on the Form) + attempt count (e.g. "75% Pass (x3)" or "75% (x3)" if no pass threshold) |
| Started (not complete) | Play icon + start datetime |
| Not started | Empty / dash |

**Why show attempt count:** Educators need to know if a student passed on the first try or needed multiple attempts — this signals comprehension level.

### Forms — Non-quiz types (CATEGORY_VALUE_SUM, no scoring)

| State | Display |
|-------|---------|
| Completed | Check mark icon + completion datetime |
| Started (not complete) | Play icon + start datetime |
| Not started | Empty / dash |

**Decision:** Non-quiz forms show completion status only (same pattern as topics). Score breakdowns for CATEGORY_VALUE_SUM forms are complex and better suited to a dedicated student detail view rather than a compact grid cell.

## Deadlines

### Cohort deadlines (header area)

- `CohortDeadline` records associated with the selected `CohortCourseRegistration` are displayed in the header, in the relevant column for the course item they apply to.
- If a deadline applies to the course as a whole (null content object), it is displayed separately above or beside the grid.
- **Hard deadlines** are styled distinctly from soft deadlines (e.g. bold text, stronger color) so educators can immediately see which deadlines are firm.

**Why distinguish hard/soft:** Hard deadlines may have consequences (e.g. lockout, grade penalty) while soft deadlines are advisory. Educators need to know the difference at a glance.

### Student deadlines (in cells)

- `StudentCohortDeadlineOverride` records are shown in the relevant cell for each student/item combination.
- When a student has an override that **differs** from the cohort default, it is visually distinguished (e.g. different color, icon) so the educator can see at a glance which students have custom deadlines.
- If no override exists, the cell inherits the cohort deadline (no duplicate display needed — the header shows it).

### Overdue highlighting

- When a deadline (cohort or student override) has passed **and** the student has **not** completed the item, the cell is visually flagged as overdue (e.g. red border/background, warning icon).
- This applies to both hard and soft deadlines, but hard deadline overdue items should be more prominently styled.

**Why highlight overdue:** This is the most time-sensitive information an educator needs. Overdue items require immediate attention, and visual flagging ensures they are not missed.

## Data fetching

The panel fetches data in two phases to avoid over-fetching. Only data for the visible window (current student page x current column page) is loaded.

Use Django's Paginator for pagination:

`from django.core.paginator import Paginator`

### Phase 1: Determine the visible window

These queries determine which students and columns to display, before any cell data is fetched:

1. **Course structure:** Use `Course.children_flat()` to get the full ordered list, then filter out CourseParts — only Topics and Forms are grid columns. Retain the CoursePart→child mapping separately for the grouped header row. Slice the filtered list by the current column page to get the **visible items** (topic/form IDs for the current column window).
2. **Cohort deadlines:** `CohortDeadline` for the selected `CohortCourseRegistration`. Filter to visible items using `content_type` and `object_id` fields (GenericForeignKey) — build a Q filter combining the Django ContentType IDs for Topic and Form with the visible item UUIDs. Also include course-level deadlines (where `content_type` and `object_id` are NULL). Displayed in headers.
3. **Paginated students:** Query `CohortMembership` for the cohort, joining to `Student` and `User` via `select_related`. LEFT JOIN to `CourseProgress` (filtered to the selected course) to get each student's `progress_percentage`. Students without a `CourseProgress` record are treated as 0% progress. Order by `progress_percentage` ascending (NULLs first). Apply `LIMIT`/`OFFSET` for the current student page. This gives us the **visible student IDs** (and their User IDs for progress lookups).

### Phase 2: Cell data (scoped to visible window only)

Using only the visible student IDs and visible item IDs:

4. **Topic progress:** `TopicProgress` filtered to the visible students AND the visible topics.
5. **Form progress:** `FormProgress` filtered to the visible students AND the visible forms. For quizzes, we need both (a) the latest completed attempt per student per form (for score/pass-fail display) and (b) the count of completed attempts per student per form (for the attempt count display). For non-quiz forms and the "started" state, the latest record (completed or not) is sufficient. Note: `FormProgress` has no `unique_together` on user+form — multiple records per user per form are expected (multiple attempts).
6. **Student deadline overrides:** `StudentCohortDeadlineOverride` for the selected registration, filtered to the visible students and visible items (using the same GenericForeignKey Q filter approach as cohort deadlines). Also include course-level overrides (NULL content_type/object_id).

This ensures we fetch only the data needed to render the current view (e.g. 20 students x 15 items = 300 cells) rather than the full cohort x full course. Use `select_related` and `prefetch_related` appropriately within each query.

## Success criteria

1. **Panel renders in `CohortInstanceView`** as a new panel, accessible via the educator interface's existing panel URL pattern.
2. **Dropdown lists all course registrations** (active and inactive with indicator) and defaults to the first active one.
3. **Grid displays correctly** with frozen headers/first column and scrollable body.
4. **Course part headers** span correctly across child items when present.
5. **Topic cells** show the correct status (complete with time, started with time, or not started).
6. **Quiz form cells** show score percentage, pass/fail, and attempt count for completed quizzes.
7. **Non-quiz form cells** show completion status only.
8. **Cohort deadlines** appear in the header row for the relevant columns, with hard/soft distinction.
9. **Student deadline overrides** appear in cells with visual distinction from cohort defaults.
10. **Overdue items** are visually flagged, with stronger styling for hard deadline violations.
11. **Students are sorted** by course progress ascending (least progress first).
12. **Pagination** works correctly for large cohorts.
13. **HTMX integration** — course selection dropdown triggers a partial reload of the grid without full page refresh.
14. **Performance** — the panel loads efficiently using batch queries with appropriate `select_related`/`prefetch_related`.
15. **Empty states** — appropriate messages when there are no course registrations, no students, or no progress data.
