{% extends "bloom_student_interface/_base_logged_in.html" %}


{% partialdef add-child-button %}

<form
        hx-post="{% url 'bloom_student_interface:children_create' %}"
        hx-target="#children"
        hx-swap="outerHTML"
    >
        {% csrf_token %}

        <c-modal title="Add Child">
            <c-slot name="trigger">
                <c-button
                hx-get="{% url 'bloom_student_interface:children_create' %}"
                hx-target="#child-form-container"
                hx-swap="innerHTML"
                hx-trigger="click">
                Add a Child
            </c-button>
        </c-slot>

        <!-- Modal content will be loaded here via HTMX -->
        <div id="child-form-container">
            <p class="text-gray-500">Loading form...</p>
        </div>

        <c-slot name="footer">
            <c-button type="button"  @click="open = false">Cancel</c-button>
            <c-button type="submit" value="Save" >Save</c-button>
        </c-slot>
    </c-modal>
</form>

{% endpartialdef %}


{% partialdef edit-child-button %}

<form
        hx-post="{% url 'bloom_student_interface:children_edit' slug=child.slug %}"
        hx-target="#children"
        hx-swap="outerHTML"
    >
        {% csrf_token %}

        <c-modal title="Edit Child">
            <c-slot name="trigger">
                <c-button
                dropdown="true"
                hx-get="{% url 'bloom_student_interface:children_edit' slug=child.slug %}"
                hx-target="#edit-child-form-container-{{child.slug}}"
                hx-swap="innerHTML"
                hx-trigger="click">
                <i class="fa fa-pencil" aria-hidden="true"></i>
                Edit
            </c-button>
        </c-slot>

        <!-- Modal content will be loaded here via HTMX -->
        <div id="edit-child-form-container-{{child.slug}}">
            <p class="text-gray-500">Loading form...</p>
        </div>

        <c-slot name="footer">
            <c-button 
                type="button" 
                @click="open = false"
                variant="secondary">Cancel</c-button>
            <c-button type="submit" value="Save">Save</c-button>
        </c-slot>
    </c-modal>
</form>

{% endpartialdef %}


{% partialdef delete-child-button %}

<form
        hx-post="{% url 'bloom_student_interface:children_delete' slug=child.slug %}"
        hx-target="#delete-child-confirmation-{{child.slug}}"
        hx-swap="innerHTML"
    >
        {% csrf_token %}

        <c-modal title="Delete Child - Confirm">
            <c-slot name="trigger">
                <c-button
                dropdown="true"
                hx-get="{% url 'bloom_student_interface:children_delete' slug=child.slug %}"
                hx-target="#delete-child-confirmation-{{child.slug}}"
                hx-trigger="click">
                <i class="fa fa-trash" aria-hidden="true"></i>

                Delete
            </c-button>
        </c-slot>

        <!-- Confirmation message will be loaded here via HTMX -->
        <div id="delete-child-confirmation-{{child.slug}}">
            <p class="text-gray-500">Loading...</p>
        </div>

        <c-slot name="footer">
            <c-button variant="secondary" @click="open = false">Cancel</c-button>
            <c-button type="submit"  value="Yes, Delete Permanently" variant="danger">Yes, Delete Permanently</c-button>
        </c-slot>
    </c-modal>
</form>

{% endpartialdef %}


{% partialdef category_scores_radar %}

<div id="scores_{{form_progress.id}}" class="w-full  mx-auto">
    <canvas id="radar_{{form_progress.id}}"></canvas>
</div>

<script>
(function() {
    const scores = {{ form_progress.scores|safe }};
    const ctx = document.getElementById('radar_{{form_progress.id}}').getContext('2d');

    // Extract categories and calculate percentages
    const labels = [];
    const data = [];

    for (const [category, categoryData] of Object.entries(scores)) {
        labels.push(category.split(" ")[0]);
        const percentage = categoryData.max_score > 0
            ? (categoryData.score / categoryData.max_score) * 100
            : 0;
        data.push(percentage.toFixed(1));
    }

    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Score %',
                data: data,
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 2,
                pointBackgroundColor: 'rgb(59, 130, 246)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgb(59, 130, 246)'
            }]
        },
        options: {
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20,
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.r.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
})();
</script>

{% endpartialdef %}

{% partialdef redo_assessment_button %}

<a href="{% url 'bloom_student_interface:child_assessment' slug=child.slug %}"
    class="btn btn-primary">
    Redo Assessment
</a>

{% endpartialdef %}



{% partialdef category_scores_table %}


<table class="w-full">
    
    {% for category, value in  form_progress.scores.items %}
        <tr>
            <th class="text-left">{{category}}</th>
            <!-- <td>
                {{value.score}} / {{value.max_score}}
            </td> -->
            <td>
                {% widthratio value.score value.max_score 100 %}%
            </td>
        </tr>
    {% endfor %}
</table>

{% endpartialdef %}




{% partialdef assessment_details_button %}
<c-modal title="{{child.name}}: Assessment Details" class="w-7xl">
    <c-slot name="trigger">
        <button class="btn btn-primary">Details</button>
    </c-slot>

    
    <p class="text-sm text-gray-600 mt-2 text-left">
                Last Assessment: {{ child.complete_assessment.completed_time|date:"M d, Y" }}
            </p>

        <div class="grid grid-cols-2 gap-3">

            <div>
                <h3>Overview</h3>
                {% partial category_scores_radar %} 
            </div>
            <div>
                <h3>Scores</h3>
                {% include "student_interface/partials/form_progress_scores.html#completed_form_category_scores"%}
            </div>
        </div>

    <c-slot name="footer">
        <button type="button" class="btn btn-outline" @click="open = false">Close</button>
        {% partial redo_assessment_button %}
        
    </c-slot>

</c-modal>

{% endpartialdef %}




{% partialdef child %}
<div class="surface grid grid-cols-6 gap-4">
    <div class="text-center col-span-2">
        <h2>{{child.name}}</h2>
        <p class="text-gray-600">Age: {{child.age}}</p>

        <c-dropdown-menu>
            {% partial edit-child-button %}
            {% partial delete-child-button %}
        </c-dropdown-menu>


        {% if child.complete_assessment %}

            <h3>Assessment</h3>
            <p class="text-sm text-gray-600 mt-2">
                Last Assessment: {{ child.complete_assessment.completed_time|date:"M d, Y" }}
            </p>

            {% partial redo_assessment_button %}


            {% with form_progress=child.complete_assessment %}
                {% partial category_scores_table %}
                {% partial assessment_details_button %}
            {% endwith %}

            

        {% endif %}

    </div>
    <div class="col-span-4 ">
        {% if child.complete_assessment %}
            <!-- <a href="{% url 'bloom_student_interface:child_assessment' slug=child.slug %}"
               class="btn btn-outline">
                View Assessment Results
            </a>
            <a href="{% url 'bloom_student_interface:child_assessment' slug=child.slug %}"
               class="btn btn-outline ml-2">
                Retake Assessment
            </a> -->

            <h3>Activities</h3>

            <div
                hx-get="{% url 'bloom_student_interface:child_current_activities' slug=child.slug %}"
                hx-trigger="load"
                id="current_activities_table_{{child.slug}}"
                
                ></div>

            <a class="btn btn-primary" href="{% url 'bloom_student_interface:child_activities_configure' slug=child.slug %}">Configure activities</a>


        {% elif child.has_incomplete_assessment %}

            <p>You'll need to finish up the assessment so we can make recommendations</p>
            <a href="{% url 'bloom_student_interface:child_assessment' slug=child.slug %}"
               class="btn btn-primary">
                Continue Assessment
            </a>
        
        {% else %}
            <div class="surface bg-blue-50 border-blue-200">
                <h4 class="text-blue-900 mb-2">Ready to Get Started?</h4>
                <p class="text-gray-700 mb-4">
                    Complete a brief assessment about your child's development and interests.
                    This helps us provide personalized course recommendations tailored to their unique needs.
                </p>
                <c-button href="{% url 'bloom_student_interface:child_assessment' slug=child.slug %}"
                   class="btn btn-primary">
                    Start Assessment
                </c-button>
            </div>
        {% endif %}
    </div>
</div>
{% endpartialdef %}



{% partialdef content %}


<div id="children">
    
    {% if children %}

    <div class="space-y-3">
        {% for child in children %}
        {% partial child %}
        {% endfor %}
    </div>

    <div class="pt-4 float-end">

        {% partial add-child-button %}
    </div>

    {% else %}

    <div class="flex flex-col items-center justify-center py-16 px-4">
        <div class="text-center max-w-md">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            <h2 class="text-2xl font-semibold text-gray-900 mb-2">No children yet</h2>
            <p class="text-gray-600 mb-6">
                Get started by adding your first child! You can add multiple children.
            </p>

                {% partial add-child-button %}
        </div>
    </div>

    {% endif %}


</div>

{% endpartialdef %}



{% block title %}
My Children
{% endblock %}


{% block content %}
    {% partial content %}
{% endblock content %}