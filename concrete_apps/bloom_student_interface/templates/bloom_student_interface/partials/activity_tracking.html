{% load dict_filters %}


{% partialdef activity_radio %}

<button 
    hx-post="{% url 'bloom_student_interface:action_child_activity_toggle' child.slug activity.slug date %}"
    hx-swap="outerHTML"
    class="cursor-pointer"
    >

    {% if done == True %}
    <i class="fa fa-check-circle text-green-600" title="Done today"></i>
    {% elif done == False %}
    <i class="fa fa-times-circle text-red-600" title="Not done today"></i>
    {% else %}
    <i class="fa fa-question-circle text-gray-400" title="Not yet marked"></i>
    {% endif %}
</button>

{% endpartialdef %}



{% partialdef view_activity_description_button %}
<c-modal title="{{activity.title}}">
    <c-slot name="trigger">
        <button class="btn btn-outline">Description</button>
    </c-slot>

    <c-markdown-container>

        {{activity.rendered_content}}
    </c-markdown-container>

    <c-slot name="footer">
        <button type="button" class="btn btn-outline" @click="open = false">Close</button>
    </c-slot>
</c-modal>
{% endpartialdef %}


{% partialdef stop_activity_button %}
<c-modal title="Are you sure?">

    <c-slot name="trigger">
        <button class="btn btn-outline">Stop</button>
    </c-slot>

    <p>Are you sure you would like to stop the activity? </p>
    <p>
        <b>{{activity.title}}</b>
    </p>

    <p>Stopping an activity will remove it from your activity tracker. You will be able to restart it at any time. We will not delete any of your activity logs, you'll still have access to everything.</p>

    <c-slot name="footer">
        <button
            type="button"
            class="btn btn-outline"
            hx-post="{% url 'bloom_student_interface:action_child_activity_start_stop' child.slug activity.slug 'stop' %}"
            
            @click="open = false"
        >Stop the activity</button>
        <button type="button" class="btn btn-outline" @click="open = false">Nevermind</button>
    </c-slot>

</c-modal>

{% endpartialdef %}


{% partialdef recommended_indicator %}
<i class="fa fa-star" aria-hidden="true" title="recommended activity"></i>
{% endpartialdef%}



{% partialdef current_activities_table %}

<div id="current_activities_table_{{child.slug}}" hx-swap-oob="true">

    {% if committed_activities %}


<table class="w-full border-collapse">
    
    <thead>
        <tr>
            <th class="text-left p-2 border-b">Activity</th>
            {% for loop_date in activity_logs %}
            <th class="text-center p-2 border-b {% if forloop.first %}bg-blue-50 font-bold{% endif %}">
                <div class="text-xs">{{ loop_date|date:"D" }}</div>
                <div class="text-sm">{{ loop_date|date:"M j" }}</div>
            </th>
            {% endfor %}
            <th class="p-2 border-b"></th>
        </tr>
    </thead>

    <tbody>
        {% for commitment in committed_activities %}
        <tr class="border-b">
            <td class="p-2">
                <div class="flex items-center gap-2">
                    <div class="font-semibold">
                        {% if commitment.activity.id in recommended_activity_ids %}
                            {% partial recommended_indicator %}
                        {% endif %}
                        {{ commitment.activity.title }}</div>
                    
                </div>
                {% if commitment.activity.category %}
                    <div class="text-sm text-gray-500">{{ commitment.activity.category }}</div>
                {% endif %}
                <c-button-group>

                    {% with activity=commitment.activity %}
                    {% partial view_activity_description_button %}
                    {% partial stop_activity_button %}
                    {% endwith %}
                </c-button-group>
            </td>
            {% for loop_date in activity_logs %}
            <td class="text-center p-2 {% if forloop.first %}bg-blue-50{% endif %}">
                {% with activity=commitment.activity done=activity_logs|dict_get:loop_date|dict_get:commitment.activity.id date=loop_date|date:"Y-m-d" %}
                {% include "bloom_student_interface/partials/activity_tracking.html#activity_radio" %}
                {% endwith %}
            </td>
            {% endfor %}
            <!-- <td class="p-2">
                <a href="{% url 'bloom_student_interface:child_activity' child.slug commitment.activity.slug %}" class="btn btn-primary text-sm">View</a>
            </td> -->
        </tr>
        {% endfor %}
    </tbody>
</table>

{% else %}

<p>
    You haven't committed to doing any activities with your child yet. 
</p>

    {% endif %}
</div>

{% endpartialdef %}





{% partialdef recommended_activities %}

<div id="recommended_activities" hx-swap-oob="true">
    {% if recommended_activities %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            
            {% for recommendation in recommended_activities %}
                <div class="surface p-4 flex flex-col">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold">{{ recommendation.activity.title }}</h3>
                        {% if recommendation.activity.category %}
                            <p class="text-sm text-gray-500">{{ recommendation.activity.category }}</p>
                        {% endif %}
                        {% if recommendation.activity.description %}
                            <p class="text-gray-600 mt-2">{{ recommendation.activity.description }}</p>
                        {% endif %}
                    </div>

                    <c-button-group>

                        {% with activity=recommendation.activity %}
                            {% include 'bloom_student_interface/partials/activity_tracking.html#view_activity_description_button'%}
                        {% endwith %}

                        <button
                            class="btn btn-outline"
                            hx-post="{% url 'bloom_student_interface:action_child_activity_start_stop' child.slug recommendation.activity.slug  'start' %}"
                            
                        >Start</button>


                    </c-button-group>
                </div>
            {% endfor %}
        </div>
    {% else %}
        {% if committed_activities %}
        <p class="text-gray-600">No new recommendations. Check back later!</p>
        <p class="text-gray-600">If you feel that you have outgrown your current recommended activities, please redo the assessment so we can come up with new recommendations for you.</p>

        
        {% else %}
        <p class="text-gray-600">No recommended activities yet. Complete an assessment to get personalized activity recommendations.</p>
        {% endif %}
    {% endif %}
</div>

{% endpartialdef %}


{% partialdef activity_history %}

<div id="activity_history" hx-swap-oob="true">
    {% if stopped_activities %}
        <div class="space-y-4">
            {% for stopped in stopped_activities %}
                <div class="surface p-4 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <h3 class="text-lg font-semibold">{{ stopped.activity.title }}</h3>
                            {% if stopped.activity.id in recommended_activity_ids %}
                               {% partial recommended_indicator %}
                            {% endif %}
                        </div>
                        {% if stopped.activity.category %}
                            <p class="text-sm text-gray-500">{{ stopped.activity.category }}</p>
                        {% endif %}
                        <p class="text-sm text-gray-500 mt-1">
                            Stopped on {{ stopped.stopped_at|date:"F j, Y" }}
                        </p>
                    </div>
                    <c-button-group>
                        {% with activity=stopped.activity %}
                            {% partial view_activity_description_button %}
                        {% endwith %}

                        <button
                            class="btn btn-outline"
                            hx-post="{% url 'bloom_student_interface:action_child_activity_start_stop' child.slug stopped.activity.slug  'start' %}"
                            hx-target="#recommended_activities"
                            hx-swap="outerHTML"
                        >Start Again</button>

                    </c-button-group>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-600">No activity history yet.</p>
    {% endif %}
</div>

{% endpartialdef %}



{% partialdef activity_start_stop_response %}

{# This partial is used when starting an activity - it updates both recommended and current activities #}

{% partial current_activities_table %}
{% partial recommended_activities %}
{% partial activity_history %}



{% endpartialdef %}